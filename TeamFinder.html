<html>

  <head>
    <title>Team Finder</title>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta http-equiv="Content-Language" content="en">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
    <script src="teams.js"></script>
    <script src="venues.js"></script>
    <script src="divisions.js"></script>

    <script language="javascript">            
      const baseUrl = 'https://uysa.affinitysoccer.com/tour/public/info/';

      let searchResults;

      function findTeams(){              
        location.hash = document.getElementById('teamQuery').value;
      };

      function runSearch(searchQuery){        
        const teamQuery = searchQuery.toUpperCase();
        teamQueryItems = teamQuery.split(' ');        

        searchResults = _.filter(teams, team => {
          return _.every(teamQueryItems, (queryItem) => {
            return team.name.toUpperCase().includes(queryItem) ||
                   (team.teamID && team.teamID.toUpperCase().includes(queryItem)) ||
                   (team.city && team.city.toUpperCase().includes(queryItem)) ||
                   (team.coach && team.coach.toUpperCase().includes(queryItem))
          })
        });

        console.log(`${teamQuery} results `, searchResults);
        
        showSearchResults();
      }

      function showSearchResults(){
        const table = document.getElementById('searchResults');
        table.innerHTML = '';

        searchResults.forEach(team => {
          const tr = document.createElement('tr');
          tr.className = 'tr';
          table.appendChild(tr);

          // name / schedule link
          {
            const td = document.createElement('td');
            td.className = 'td';    
            tr.appendChild(td);            
            const a = document.createElement('a');
            a.setAttribute('href', '#');
            a.setAttribute('onclick', `showTeamStats("${team.name}"); return false;`);
            td.appendChild(a);
            const text = document.createTextNode(team.name);
            a.appendChild(text);
          }

          ['rank', 'city', 'teamID', 'coach'].forEach(fieldName => {
            const td = document.createElement('td');
            td.className = 'td';
            tr.appendChild(td);
            const text = document.createTextNode(team[fieldName]);
            td.appendChild(text);
          });

          // Primary field / address
          {
            const primaryVenue = getTeamPrimaryVenue(team);
            const td = document.createElement('td');
            td.className = 'td';
            tr.appendChild(td);            
            const a = document.createElement('a');
            if(primaryVenue){ // some teams don't have a venue
              a.setAttribute('href', `https://www.google.com/maps/place/${encodeURIComponent(primaryVenue.address)}`);
            }
            td.appendChild(a);
            if(primaryVenue){
              const text = document.createTextNode(primaryVenue.name);
              a.appendChild(text);
            }            
          }

          // bracket link
          {
            const td = document.createElement('td');
            td.className = 'td';
            tr.appendChild(td);            
            const a = document.createElement('a');
            a.setAttribute('href', `${baseUrl}${divisions[team.division].bracketsLink}`);
            td.appendChild(a);
            const text = document.createTextNode(team.division);
            a.appendChild(text);
          }                    
        });        
      }

      window.onload = function(){
        document.getElementById('teamQuery').addEventListener('keypress', (event) => {
          if (event.keyCode == 13) {
            findTeams();
          }
        });

        window.onhashchange = function(){
          const searchInput = decodeURIComponent(location.hash.replace('#', ''));
          runSearch(searchInput);
          document.getElementById('teamQuery').value = searchInput;
        }
        
        window.onhashchange();
      }

      function clearStats(){
        const statsDiv = document.getElementById('stats');
        statsDiv.innerHTML = '';
      }

      function showTeamStats(teamName){
        const teamStats = teams[teamName].stats;
        const statsDiv = document.getElementById('stats');
        statsDiv.innerHTML = '';

        // team name
        {
          const div = document.createElement('div');
          statsDiv.appendChild(div);
          const text1 = document.createTextNode(`${teamName} record: (placed ${teams[teamName].rank})`);
          div.appendChild(text1);

          const button = document.createElement('button');
          button.className = 'button';
          button.style = 'margin-left: 500px;';
          button.setAttribute('onclick', 'clearStats(); return false;');
          const text2 = document.createTextNode('Close stats');
          button.appendChild(text2);
          div.appendChild(button);
        }

        const table = document.createElement('table');
        table.className = 'table';  
        statsDiv.appendChild(table);

        // Headers
        {
          const tr = document.createElement('tr');
          tr.className = 'tr';
          table.appendChild(tr);

          ['Games Played', 'Won', 'Lost', 'Tied', 'Goals For', 'For Per Game', 'Goals Against', 'Against Per Game'].forEach( columnTitle => {
            const td = document.createElement('td');
            td.className = 'td';
            tr.appendChild(td);
            const text = document.createTextNode(columnTitle);
            td.appendChild(text);
          });
        }

        // Stats
        {
          const tr = document.createElement('tr');
          tr.className = 'tr';
          table.appendChild(tr);

          ['gameCount', 'winCount', 'lossCount', 'tieCount', 'goalsFor', 'goalsForPerGame', 'goalsAgainst', 'goalsAgainstPerGame'].forEach( fieldName => {
            let value = teamStats[fieldName];

            if(fieldName === 'goalsForPerGame'){
              value = (teamStats.goalsFor / teamStats.gameCount).toFixed(1);
            }
            else if(fieldName === 'goalsAgainstPerGame'){
              value = (teamStats.goalsAgainst / teamStats.gameCount).toFixed(1);
            }
            
            const td = document.createElement('td');
            td.className = 'td';
            tr.appendChild(td);
            const text = document.createTextNode(value);
            td.appendChild(text);
          });
        }

        // chart
        {
          const canvas = document.createElement('canvas');
          canvas.width = 600;
          canvas.height = 300;
          statsDiv.appendChild(canvas);
          const context2d = canvas.getContext('2d');
          const dates = Object.keys(teamStats.timeline);
          const labels = dates.map(date => {return `${teamStats.timeline[date].opponentName} ${date}`;});
          const chartData = {labels, datasets: []};                        
          
          [{label: 'Win (win=2,tie=1,loss=0', key: 'winStat', color: 'rgba(18, 185, 18, 0.8)'},
           {label: 'Goals', key: 'goalsFor', color: 'rgba(243, 243, 30, .8)'},
           {label: 'Goals Against', key: 'goalsAgainst', color: 'rgba(193, 41, 41, 0.8)'}].forEach(({label, key, color}) => {
            const data = [];
            const backgroundColor = [];
            const borderColor = [];
            dates.forEach(date => {
              data.push(teamStats.timeline[date][key]);
              backgroundColor.push(color);
              borderColor.push(color);
            });
            chartData.datasets.push({label,data, backgroundColor, borderColor});
          });


          new Chart(context2d, {
            type: 'line',
            data: chartData,            
            options: {
              // tooltips: {
              //   custom: function(model){
              //     if(model.title && model.title.length > 0){                    
              //       const selectedDate = model.title[0];
              //       model.title[0] = `vs ${teamStats.timeline[selectedDate].opponentName}`;
              //     }
              //   }
              // },
              scales: {
                yAxes: [{
                  ticks: {
                    beginAtZero: true
                  }
                }]
              }
            }

          })
        }

        // Add a bit of spacing
        {
          const br = document.createElement('br');          
          statsDiv.appendChild(br);
        }

      }

      function getTeamPrimaryVenue(team){        
        if(!team.pimaryVenue){
          let maxName = 'missing';
          let maxCount = 0;

          Object.keys(team.stats.homeVenueCounts).forEach(venueName => {
            if(team.stats.homeVenueCounts[venueName] > maxCount){
              maxCount = team.stats.homeVenueCounts[venueName];
              maxName = venueName;
            }
          });

          team.primaryVenue = venues[maxName];
        }

        return team.primaryVenue;
      }

    </script>
  </head> 

  <body class="">
    <section class="section">
      <div class="container">
        <h1 class="title">
          UYSA Team Finder
        </h1>
        <div>
          <input class="input" id="teamQuery" type="text" placeholder="Search by team name, coach name, city or team id"/>
          <button class="button" onclick="findTeams()" style="margin-top: 10px;">Find teams!</button>
        </div>
        <hr>
        <div id="stats"></div>
        <table class="table">
          <thead>
            <tr>
              <td>Team</td>
              <td>Div. Rank</td>              
              <td>City</td>
              <td>Team ID</td>
              <td>Coach</td>
              <td>Primary Field</td>
              <td>Division</td>
            </tr>
          </thead>
          <tbody id="searchResults">

          </tbody>
        </table>
      </div>
    </section>
  </body>

  <!-- Copyright Bart Wood, MIT License-->
</html>